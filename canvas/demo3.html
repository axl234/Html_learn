<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>Canvas render Video</title>
	<style>
		body{
			padding:0;
			margin:0;
		}
		video{
			width:100%;
			/*opacity: 0;*/
		}
	</style>
</head>
<body>
	<canvas></canvas>
	<video preload="auto" webkit-playsinline="true" playsinline="true">
		<source src="../media/birthday-demo.mp4" type="video/mp4">
	</video>
	<script type="text/javascript">
		document.addEventListener('DOMContentLoaded',function(){

			window.requestAnimFrame = (function() {
				return window.requestAnimationFrame ||
						window.mozRequestAnimationFrame ||
						window.webkitRequestAnimationFrame ||
						window.msRequestAnimationFrame ||
						window.webkitRequestAnimationFrame;
			})();

			//canvas、video宽高
			var width;
			var height;

			var video = document.querySelector('video');

			var canvas = document.querySelector('canvas');
			var context = canvas.getContext('2d');

			document.addEventListener('click',function(){
				initCanvas();
				video.play();
			},false);

			video.addEventListener('play',function(){
				drawVideo();
			},false);

			function drawVideo(){
				context.drawImage(video,0,0,width,height);

				//色值处理
				var idata = context.getImageData(0,0,width,height);
				var data = idata.data;
				for(var i = 0; i < data.length; i+=4) {
					var r = data[i];
					var g = data[i+1];
					var b = data[i+2];
					if(r==0&&g==0&&b==0){
						data[i+3] = 0;//如果为黑色则设置为透明
					}
				}
				idata.data = data;
				context.putImageData(idata,0,0);

				window.requestAnimFrame(drawVideo);
			}
			function initCanvas(){
				var videoStyle = window.getComputedStyle(video);
				width = parseInt(videoStyle.width);
				height = parseInt(videoStyle.height);
				canvas.style.width = width+'px';
				canvas.style.height = height+'px';
				canvas.width = width;
				canvas.height = height;
			}
		},false);
	</script>
</body>
</html>