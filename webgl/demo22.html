<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>简单WebAR示例</title>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimal-ui">
    <style>
        body{
            margin:0;
            padding:0;
            width:100%;
            height:100%;
        }
        .video-wrap{
            position: relative;
            overflow:hidden;
        }
        .video-wrap .canvas-frame,
        .video-wrap .media-video{
            position: absolute;
            top:0;
            left:0;
            right:0;
            bottom:0;
            z-index:10;
        }
        .video-wrap .canvas-frame{
            z-index:20;
        }
    </style>
    <script type="text/javascript" src="../lib/three.js"></script>
    <script type="text/javascript" src="../lib/three-deviceorientation-controls.js"></script>
</head>
<body>
<!-- Android手机摄像头视频全屏只需要给视频套个容器然后让容器全屏即可，视频本身不需要任何处理 -->
<div class="video-wrap">
    <video class="media-video" autoplay></video>
    <div class="canvas-frame"></div>
</div>
<script type="text/javascript">

    /**
     * 这种方式只是简单的叠加WebGL场景和摄像头场景，由于WebGL场景中的摄像机位置和光照等参数并没有和摄像头场景中的参数达成一致，因此效果并不好。
     */
    window.onload = function () {

        //user-media
        var video = document.querySelector('.media-video');
        var videoWrap = document.querySelector('.video-wrap');

        //让视频容器充满整个屏幕
        videoWrap.style.width = window.innerWidth+'px';
        videoWrap.style.height = window.innerHeight+'px';

        var exArray = []; //存储设备源ID
        MediaStreamTrack.getSources(function (sourceInfos) {
            for (var i = 0; i != sourceInfos.length; ++i) {
                var sourceInfo = sourceInfos[i];
                //这里会遍历audio,video，所以要加以区分
                if (sourceInfo.kind === 'video') {
                    exArray.push(sourceInfo.id);
                }
            }

            navigator.mediaDevices.getUserMedia({
                video: {
                    optional:[{
                        sourceId:exArray[1]//0为前置摄像头，1为后置
                    }]
                }
            }).then(success).catch(error);
        });

        function success(stream) {
            video.src = window.webkitURL.createObjectURL(stream);
        }

        function error(err) {
            alert('video error: ' + err)
        }

        //webgl
        var renderer;//渲染器
        var width;//页面宽度
        var height;//页面高度
        var controls;//控制器

        window.requestAnimFrame = (function() {//如果有变化则可能还需要requestAnimationFrame刷新
            return window.requestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.msRequestAnimationFrame ||
                    window.webkitRequestAnimationFrame;
        })();

        //开始
        function threeStart() {
            initThree();
            initCamera();
            initScene();
            initLight();
            initObject();
            render();
        }

        //根据页面宽度和高度创建渲染器，并添加容器中
        function initThree() {
            width = window.innerWidth;
            height = window.innerHeight;
            renderer = new THREE.WebGLRenderer({
                antialias : true,
                alpha:true//背景区域渲染是否透明
            });
            renderer.setSize(width, height);
            document.querySelector('.canvas-frame').appendChild(renderer.domElement);
        }
        //创建相机，并设置正方向和中心点
        var camera;
        function initCamera() {
            camera = new THREE.PerspectiveCamera(45, width / height, 1, 1000);
            controls = new THREE.DeviceOrientationControls( camera );
        }
        //创建场景，后续元素需要加入到场景中才会显示出来
        var scene;
        function initScene() {
            scene = new THREE.Scene();
        }
        //创建光线
        var hemisphereLight,shadowLight,shadowLight2;
        function initLight() {
            // 第一个参数是天空的颜色，第二个参数是地上的颜色，第三个参数是光源的强度
            hemisphereLight = new THREE.HemisphereLight(0xaaaaaa,0x000000, 1);

            scene.add(hemisphereLight);

            shadowLight = new THREE.DirectionalLight(0xffffff, .6);
            shadowLight.position.set(150,200,300);

            scene.add(shadowLight);

            shadowLight2 = new THREE.DirectionalLight(0xffffff, .6);
            shadowLight2.position.set(-150,-200,-300);
            scene.add(shadowLight2);
        }
        //创建展示场景所需的各种元素
        var cube
        function initObject() {
            //正方体
            var cubegeo = new THREE.BoxGeometry( 100, 100, 100 );
            for ( var i = 0; i < cubegeo.faces.length; i += 2 ) {
                var hex = Math.random() * 0xffffff;
                cubegeo.faces[ i ].color.setHex( hex );
                cubegeo.faces[ i + 1 ].color.setHex( hex );
            }
            var cubemat = new THREE.MeshBasicMaterial({vertexColors: THREE.FaceColors});
            cube = new THREE.Mesh( cubegeo, cubemat );
            cube.position.z = 400;

            scene.add( cube );
        }
        //渲染
        function render(){
            renderer.clear();
            cube.rotation.y += 10/1000;//绕y轴旋转
            renderer.render(scene, camera);
            controls.update();
            window.requestAnimationFrame( render );
        }

        threeStart();
    }
</script>
</body>
</html>