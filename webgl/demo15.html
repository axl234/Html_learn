<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>简易太阳系</title>
    <script src="../lib/three.js"></script>
    <script src="../lib/three-orbit-controls.js"></script>
    <style type="text/css">
        body{
            margin:0;
            padding:0;
            overflow:hidden;
        }
        div#canvas-frame {
            cursor: pointer;
            width:100%;
            height:100%;
            background-color: #EEEEEE;
        }
    </style>
</head>
<body onload="threeStart();">
    <div id="canvas-frame"></div>
    <script>
        var renderer;//渲染器
        var width;//页面宽度
        var height;//页面高度

        window.requestAnimFrame = (function() {//如果有变化则可能还需要requestAnimationFrame刷新
            return window.requestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.msRequestAnimationFrame ||
                    window.webkitRequestAnimationFrame;
        })();

        //开始
        function threeStart() {
            initThree();
            initCamera();
            initScene();
            initLight();
            initObject();
            render();
        }

        //根据页面宽度和高度创建渲染器，并添加容器中
        function initThree() {
            width = window.innerWidth;
            height = window.innerHeight;
            renderer = new THREE.WebGLRenderer({
                antialias : true
            });
            renderer.setSize(width, height);
            renderer.setClearColor(0xFFFFFF, 1.0);
            document.getElementById('canvas-frame').appendChild(renderer.domElement);
        }

        //创建相机，并设置正方向和中心点
        var camera;
        var control;
        function initCamera() {
            camera = new THREE.PerspectiveCamera(75, width / height, 1, 1000);
            camera.position.x = 0;
            camera.position.y = 0;
            camera.position.z = 100;
            camera.up.x = 0;//正方向
            camera.up.y = 1;
            camera.up.z = 0;
            camera.lookAt({
                x : 0,
                y : 0,
                z : 0
            });

            //视角控制
            controller = new THREE.OrbitControls(camera, renderer.domElement);
            controller.target = new THREE.Vector3(0, 0, -75);//设置控制点
        }

        //创建场景，后续元素需要加入到场景中才会显示出来
        var scene;
        function initScene() {
            scene = new THREE.Scene();
        }

        //创建光线
        var light;
        function initLight() {
            //light = new THREE.AmbientLight(0xfefefe);
            //scene.add(light);
        }

        //创建展示场景所需的各种元素
        var sun;
        var earth;
        var mars;
        var mercury;  //水星
        var venus;  //金星
        var jupiter; //木星
        var saturn; //土星
        var uranus; //天王
        var neptune; //海王
        function initObject() {
            sun = new THREE.Mesh(new THREE.SphereGeometry(12,16,16),new THREE.MeshLambertMaterial({
                color:0xff00ff,
                emissive:0xdd4422
            }))
            sun.name = 'Sun';
            scene.add( sun );

            earth = initPlanet('Earth','rgb(46,69,119)',40,5,0.010);
            mars = initPlanet('Mars','rgb(210,81,16)',50,4,0.008);
            mercury = initPlanet('Mercury','rgb(124,131,203)',20,2,0.02);
            venus = initPlanet('Venus','rgb(190,138,44)',30,4,0.012);
            jupiter = initPlanet('Jupiter','rgb(254,208,101)',70,9,0.006);
            saturn = initPlanet('Saturn','rgb(210,140,39)',100,7,0.005);
            uranus = initPlanet('Uranus','rgb(49,168,218)',120,4,0.003);
            neptune = initPlanet('Neptune','rgb(84,125,204)',150,3,0.002);
        }

        /**
         * 初始化行星
         * @param name 行星名字
         * @param color 颜色
         * @param distance 距离原点（太阳中心）的距离
         * @param volume 体积
         * @param speed 公转角速度
         */
        function initPlanet(name,color,distance,volume,speed){
            var mesh = new THREE.Mesh(new THREE.SphereGeometry(volume,16,16),new THREE.MeshLambertMaterial({
                emissive:color
            }));
            mesh.position.z = -distance;
            //mesh.castShadow = true;
            //mesh.receiveShadow = true;
            mesh.name = name;
            mesh.speed = speed;
            mesh.radian = 0;
            scene.add(mesh);
            return mesh;
        }

        //绕世界坐标系Y轴旋转
        function rotateAroundWorldY(obj,rad){
            var x0 = obj.position.x;
            var z0 = obj.position.z;
            /**
             * 因为物体本身的坐标系是随着物体的变化而变化的，
             * 所以如果使用rotateZ、rotateY、rotateX等方法，
             * 多次调用后就会出问题，先改为Quaternion实现。
             */
            var q = new THREE.Quaternion();
            q.setFromAxisAngle( new THREE.Vector3( 0, 1, 0 ), rad );
            obj.quaternion.premultiply( q );
            //obj.rotateY(rad);
            obj.position.x = Math.cos(rad)*x0+Math.sin(rad)*z0;
            obj.position.z = Math.cos(rad)*z0-Math.sin(rad)*x0;
        }

        //矩阵方式实现绕世界坐标系Y轴旋转，但是不清楚为啥不能在render方法里边调用，不知道是不是OrbitControls控制器的原因
//        function rotateAroundWorldY(obj,rad){
//            var rad = 45*Math.PI/180;
//            var ry = new THREE.Matrix4();
//            ry.set(Math.cos(-rad),0,-Math.sin(-rad),0,
//                    0,1,0,0,
//                    Math.sin(-rad),0,Math.cos(-rad),0,
//                    0,0,0,1);
//            obj.applyMatrix(ry);
//        }

        //行星绕太阳公转
        function rotateAroundSun(){
            rotateAroundWorldY(earth,earth.speed);
            rotateAroundWorldY(mars,mars.speed);
            rotateAroundWorldY(mercury,mercury.speed);
            rotateAroundWorldY(venus,venus.speed);
            rotateAroundWorldY(jupiter,jupiter.speed);
            rotateAroundWorldY(saturn,saturn.speed);
            rotateAroundWorldY(uranus,uranus.speed);
            rotateAroundWorldY(neptune,neptune.speed);
        }

        //渲染
        function render(){
            renderer.clear();
            rotateAroundSun();
            renderer.render(scene, camera);
            window.requestAnimFrame(render);
        }

    </script>
</body>
</html>