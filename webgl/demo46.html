<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ThreeJS 虫洞效果</title>
    <script type="text/javascript" src="../lib/three.js"></script>
    <style type="text/css">
        body{
            margin:0;
            padding:0;
        }
        div#canvas-frame {
            cursor: pointer;
            width:100%;
            height:100%;
            background-color: #EEEEEE;
        }
    </style>
</head>
<body onload="threeStart();">
<div id="canvas-frame"></div>
<script>
    var renderer;//渲染器
    var width;//页面宽度
    var height;//页面高度

    window.requestAnimFrame = (function() {//如果有变化则可能还需要requestAnimationFrame刷新
        return window.requestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.msRequestAnimationFrame ||
                window.webkitRequestAnimationFrame;
    })();

    //开始
    function threeStart() {
        initThree();
        initScene();
        initLight();
        initObject();
        initCamera();
        render();
    }

    //根据页面宽度和高度创建渲染器，并添加容器中
    function initThree() {
        width = window.innerWidth;
        height = window.innerHeight;
        renderer = new THREE.WebGLRenderer({
            antialias : true
        });
        renderer.setSize(width, height);
        renderer.setClearColor(0xFFFFFF, 1.0);
        document.getElementById('canvas-frame').appendChild(renderer.domElement);
    }

    //创建相机，并设置正方向和中心点
    var camera;
    var percent = 0;
    function initCamera() {
        var initPosition = curve.getPointAt(0);
        camera = new THREE.PerspectiveCamera(45, width / height, 0.001, 1000);
        camera.position.set(initPosition.x,initPosition.y,initPosition.z);
    }

    //创建场景，后续元素需要加入到场景中才会显示出来
    var scene;
    function initScene() {
        scene = new THREE.Scene();
    }

    //创建光线
    var light;
    function initLight() {
        light = new THREE.PointLight(0xffffff,1, 50);
        scene.add(light);
    }

    //创建展示场景所需的各种元素
    var curve;
    function initObject() {
        //曲线路径
        curve = new THREE.CatmullRomCurve3( [
            new THREE.Vector3( 68.5, 0, 185.5 ),
            new THREE.Vector3( 1, 0, 262.5 ),
            new THREE.Vector3( 270.9, 0, 281.9 ),
            new THREE.Vector3( 345.5, 0, 212.8 ),
            new THREE.Vector3( 178, 0, 155.7 ),
            new THREE.Vector3( 240.3, 0, 72.3 ),
            new THREE.Vector3( 153.4, 0, 0.6 ),
            new THREE.Vector3( 52.6, 0, 53.3 ),
            new THREE.Vector3( 68.5, 0, 185.5 )
        ] );

        //根据曲线路径生成管道
        var geometry = new THREE.TubeGeometry( curve, 300, 2, 20, false );


        //demo1
        var material = new THREE.MeshLambertMaterial({
            color: 0xff0000,
            side : THREE.BackSide
        });

        //demo2
        for(var i=0,j=geometry.faces.length;i<j;i++){
            geometry.faces[i].color = new THREE.Color("hsl("+Math.floor(Math.random()*360)+",50%,50%)");
        }
        var material = new THREE.MeshLambertMaterial({
            side : THREE.BackSide,
            vertexColors : THREE.FaceColors //We need to tell ThreeJs that the colors are coming from the faces
        });

        var tube = new THREE.Mesh( geometry, material );
        scene.add( tube );
    }

    //渲染
    var itemLen = 0.0001;
    var frontLen = 0.001;
    function render(){
        renderer.clear();

        percent += itemLen;
        var newP = curve.getPointAt(percent%1);
        camera.position.set(newP.x,newP.y,newP.z);

        var frontP = curve.getPointAt((percent+frontLen)%1);
        camera.lookAt(frontP);

        light.position.set(frontP.x,frontP.y,frontP.z);

        renderer.render(scene, camera);
        window.requestAnimFrame(render);
    }
</script>
</body>
</html>