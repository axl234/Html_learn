<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>串并连奖项审核 DEMO</title>
    <style>
      table td {
        border: 1px solid #000;
        margin: 1px;
      }
    </style>
  </head>
  <body>
    <script src="../lib/state-machine.js"></script>
    <script>
      window.onload = function () {
        var data1 = ["A", "B", "C", "D", "E"]; //串连
        var data2 = ["A", ["B", "C", 2], "D", ["E", "F", 2], "G"]; //串+并连 简单混合
        var data3 = [
          "A",
          [["B", [["C", "D"], "E", "F", 2]], ["G", "H"], 2],
          "I",
        ]; //串+并连 复杂混合

        var data5 = ['M',['O','M','K',1],[['W'],'R','D','Z','G'],'O','A']

        var data4 = randomDemo(0);
        console.log(data4);
        var list1 = new CheckList(data5);
        list1.table();
      };

      //生成随机数据
      function randomDemo(kIndex){
        let keys = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
        let index = kIndex ? kIndex : '0';
        let iArr = index.split('-');
        let len = parseInt(Math.random() * 9) + 1; //1 - 10
        let array = [];
        for(let i=0;i<len;i++){
          let isNode = Math.random() > Math.pow(0.5, iArr.length) ? true : false; //是否元素节点
          if(kIndex == '0' && (i==0 || i==len-1)){ //最外层起始和结束必须为元素节点
            isNode = true;
          }
          if(isNode){
            let kNo = parseInt(Math.random() * keys.length);
            array.push(keys.splice(kNo,1)[0]);
          }else{
            array.push(this.randomDemo(index+'-'+i));
          }
        }

        if(index != '0'){ //最外层必须为串行列表
          let type = Math.random() > 0.5 ? 1 : 0;
          if(type == 1){
            array.push(parseInt(Math.random() * array.length));
          }
        }

        return array;
      }

      //审核列表
      function CheckList(list, cur, history) {
        /**
         * 列表说明
         * 1、第一项 和 最后一项必须为单项；
         * 2、不允许重复关键字；
         * 3、数组末尾存在数字，则数组元素属于并行结构，该数字表示并行结构中的最少通过数；没有数字则属于串行结构；
         * 4、子数组不能为空
         */

        //列表校验
        this.list = list;

        let defCur = {
          keys: [this.list[0]],
          indexs: ["0"],
        };

        this.status = 0; // 0 未评审、1 通过、2 未通过、3 驳回
        this.cur = cur ? cur : defCur;
        this.history = history && history.length > 0 ? history : []; // 历史记录
      }

      // CheckList.prototype.check = function () {
      //   //根据历史记录校验当前状态
      //   //历史记录不能存在状态为 0 的记录
      //   //历史记录不能存在重复记录
      // };

      //完成（整体通过或者结束）
      CheckList.prototype.finish = function(list, index){
        //列表已完成，删除归属于当前列表的流程
        let newKeys = [];
        let newIndexs = [];
        for(let i=0;i<this.cur.indexs.length;i++){
          if(this.cur.indexs[i].indexOf(index) != 0){ //列表
            newKeys.push(this.cur.keys[i]);
            newIndexs.push(this.cur.indexs[i]);
          }
        }
        this.cur.keys = newKeys;
        this.cur.indexs = newIndexs;

        //递归处理父列表
        let parent = this.getList(index);
        let pStatus = this.getListStatus(parent.list);
        if(pStatus == 2 || pStatus == 1){
          this.finish(parent.list, parent.index);
        }else{
          this.next(index);
        }
      }

      //下一步 - 元素节点
      CheckList.prototype.nextNode = function(node, index){
        let exist = false;
        for(let i=0;i<this.history.length;i++){
          let hItem = this.history[i];
          if(hItem.key == node){ //存在操作记录
            if(hItem.status == 2){
              //nothing
            }else if(hItem.status == 1){
              this.next(index); //再下一步
            }else{ //继续处理
              let update = false;
              hItem.index = index; //更新索引
              for(let z=0;z<this.cur.keys.length;z++){
                if(this.cur.keys[z] == node){
                  this.cur.indexs[z] = index;
                  update = true;
                  break;
                }
              }
              if(!update){
                this.cur.keys.push(node);
                this.cur.indexs.push(index);
              }
            }
            exist = true;
            break;
          }
        }
        if(!exist){
          this.cur.keys.push(node);
          this.cur.indexs.push(index);
        }
      }

      //下一步 - 列表节点
      CheckList.prototype.nextList = function(list, index){
        if(!Array.isArray(list)){
          throw new Error(JSON.stringify({
            errMsg: '参数必须为数组',
            data: {
              list: list
            }
          }))
        }
        if(list.length <= 0){
          throw new Error(JSON.stringify({
            errMsg: '列表节点不能为空',
            data: {
              list: list
            }
          }))
        }

        let lStatus = this.getListStatus(list);
        if(lStatus == 1 || lStatus == 2){
          this.finish(list, index);
        }else{
          if(this._isNumber(list[list.length-1])){ //并行列表
            for(let i=0;i<list.length-1;i++){
              let iNode = list[i];
              let iIndex = index+'-'+i;
              if(Array.isArray(iNode)){ //列表节点
                this.nextList(iNode, iIndex);
              }else{ // 元素节点
                this.nextNode(iNode, iIndex);
              }
            }
          }else{ //串行列表
            let firstNode = list[0];
            let firstIndex = index+'-0';
            if(Array.isArray(firstNode)){
              this.nextList(firstNode, firstIndex);
            }else{
              this.nextNode(firstNode, firstIndex);
            }
          }
        }
      }

      //下一步
      CheckList.prototype.next = function(curIndex){
        let list = this.getList(curIndex);
        let llt = list.list;
        let llStatus = this.getListStatus(llt);
        if(llStatus == 1 || llStatus == 2){
          this.finish(list.list, list.index);
        }else{
          if(!this._isNumber(llt[llt.length-1])){ //当前节点所在列表为串行列表
            let arr = curIndex.split('-');
            let next = parseInt(arr[arr.length-1]) + 1;
            let nextNode = llt[next]
            if(!nextNode){
              throw new Error(JSON.stringify({
                errMsg: '列表节点不存在',
                data: {
                  list: list,
                  no: next
                }
              }))
            }

            //nextIndex
            let nextIndex = '';
            for(let i=0;i<arr.length-1;i++){
              nextIndex += arr[i]+'-';
            }
            nextIndex += next;

            if(Array.isArray(nextNode)){ //列表节点
              this.nextList(nextNode, nextIndex);
            }else{ // 元素节点
              this.nextNode(nextNode, nextIndex);
            }
          }else{ //当前节点所在列表为并行列表
            //并行列表删除当前流程即可
          }
        }
      }

      //拒绝
      CheckList.prototype.reject = function(key){
        this.check(key,2);
      }

      //驳回
      CheckList.prototype.wait = function(key){
        this.check(key,3);
      }

      //通过
      CheckList.prototype.pass = function (key) {
        this.check(key,1);
      };

      //执行校验操作
      CheckList.prototype.check = function(key, status){
        if (!this.cur.keys.includes(key)) { //查询是否处于当前流程
          throw new Error(JSON.stringify({
            errMsg: '未匹配到当前流程',
            data:{
              keys: this.cur.keys,
              key: key
            }
          }))
        }

        if (this.status == 2){ //未通过状态
          throw new Error(JSON.stringify({
            errMsg: '处于未通过状态，不能再进行操作'
          }))
        }

        let no = this.cur.keys.indexOf(key);
        let index = this.cur.indexs[no];
        let exist = false;
        for(let i=0;i<this.history.length;i++){
          let hItem = this.history[i];
          if(hItem.key == key){ //操作记录中存在
            let hStatus = hItem.status;
            if(hStatus == 2){
              throw new Error(JSON.stringify({
                errMsg: '处于未通过状态，不能再进行操作'
              }))
            }
            hItem.index = index;
            hItem.status = status;
            exist = true;
            break;
          }
        }
        if(!exist){
          this.history.push({ //加入操作历史记录
            key: key,
            index: index,
            status: status,
          });
        }
        this.status = this.getListStatus(this.list); //更新状态

        if(status == 1 || status == 2){ //通过或者未通过
          this.cur.keys.splice(no, 1); //删除当前流程
          this.cur.indexs.splice(no, 1);

          if(this.status != 1 && this.status != 2){ //整个流程未处理完成
            this.next(index); //下一步
          }
        }else{
          //驳回还可以继续操作，对状态没有影响
        }
      }

      //查找当前元素所在的审核列表
      CheckList.prototype.getList = function (index) {
        let arr = index.split("-");
        if(arr && arr.length>=1){
          if (arr.length == 1) { //只有一层序号，最外层列表
            return {
              index : -1,
              list : this.list
            };
          } else {
            let list = this.list;
            let listIndex = '';
            for (let i = 0; i < arr.length - 1; i++) {
              list = list[arr[i]];
              listIndex += arr[i]+'-';
            }
            listIndex = listIndex.substring(0, listIndex.length-1);//去掉最后一位横线

            if(Array.isArray(list) && list.length > 0){
              return {
                index: listIndex,
                list: list
              };
            }else{
              throw new Error(JSON.stringify({
                errMsg: '列表数据异常',
                data: {
                  list: list,
                  index: listIndex
                }
              }))
            }
          }
        }else{
          throw new Error(JSON.stringify({
            errMsg: '节点索引异常',
            data: index
          }))
        }
      };

      //获取节点状态
      CheckList.prototype.getKeyStatus = function(key){
        for(let i=0;i<this.history.length;i++){
          let hItem = this.history[i];
          if(hItem.key == key){
            if(hItem.status == 0){
              throw new Error(JSON.stringify({
                errMsg: '操作记录中不能存在未评审',
              }))
            }else if(hItem.status == 2){
              return {
                status: 2,
                name: '未通过'
              };
            }else if(hItem.status == 1){
              return {
                status: 1,
                name: '通过'
              };
            }else if(hItem.status == 3){
              return {
                status: 3,
                name: '驳回'
              };
            }else{
              throw new Error(JSON.stringify({
                errMsg: '节点状态异常',
                data: {
                  key: key,
                  status: hItem.status
                }
              }))
            }
          }
        }

        return {
          status: 0,
          name: '未评审'
        };
      }

      /**
       * 获取审核列表状态
       * 0 未评审、1 通过、2 未通过、3 驳回
       * 串行列表全部通过，并行列表满足通过条件（1 通过）
       * 列表没有满足通过条件且未通过数量已经超过阀值（2 未通过）
       * 列表没有满足通过条件，未通过数量没有超过阀值，且存在驳回状态（3 驳回）
       * 其它未评审
       */
      CheckList.prototype.getListStatus = function(list){
        if(!Array.isArray(list)){
          throw new Error(JSON.stringify({
            msg: '参数必须为数组',
            data: list
          }))
        }
        if(list.length<=0){
          throw new Error(JSON.stringify({
            msg: '列表元素不能为空',
            data: list
          }))
        }

        let status = 0;
        let total = list.length; // 总流程数
        let finish = list.length; // 最少通过数
        if(this._isNumber(list[list.length-1])){ //并行列表
          total = list.length-1;
          finish = list[list.length - 1];
        }

        let pass = 0; //目前通过数
        let reject = 0; //目前未通过数
        let wait = 0; //目前驳回数

        for(let i=0;i<list.length;i++){
          let item = list[i];
          if(Array.isArray(item)){ //列表元素
            let iStatus = this.getListStatus(item);
            if(iStatus == 1){
              pass++;
            }else if(iStatus == 2){
              reject++;
            }else if(iStatus == 3){
              wait++;
            }
          }else{ //节点元素
            for (j = 0; j < this.history.length; j++) {
              if (this.history[j].key == item) {
                if(this.history[j].status == 1){
                  pass++;
                }else if(this.history[j].status == 2){
                  reject++;
                }else if(this.history[j].status == 3){
                  wait++;
                }
                break;
              }
            }
          }
        }

        if(pass >= finish){
          status = 1;
        }else{
          if((total - reject) < finish ){
            status = 2;
          }else if(wait > 0){
            status = 3;
          }else{
            status = 0;
          }
        }

        return status;
      }

      //构建 table 可视化 demo
      CheckList.prototype.table = function () {
        this.$table = document.createElement("table");
        this.$table.innerHTML = this._array(this.list);
        document.body.appendChild(this.$table);

        this.$control = document.createElement("div");
        this.$control.style.marginTop = '5px';
        let controlHtml = '';
        controlHtml += `
          <p style="padding:0;margin:0;"></p>
          <div>
            <button>通过</button>
            <button>驳回</button>
            <button>拒绝</button>
          </div>
        `
        this.$control.innerHTML = controlHtml;
        document.body.appendChild(this.$control);

        this.$name = this.$control.children[0];
        let self = this;
        this.$table.addEventListener('click',function(e){
          let $target = e.target;
          if($target.getAttribute('node-type') == 'key'){
            let key = $target.innerHTML.trim();
            let status = self.getKeyStatus(key);
            self.$name.innerHTML = key+' '+status.name;
            self.$name.setAttribute('node-key',key);
          }
        })

        //操作按钮
        this.$pass = this.$control.children[1].children[0];
        this.$pass.addEventListener('click',function(){
          if(self.$name){
            let key = self.$name.getAttribute('node-key');
            self.pass(key);
            self.update();
          }
        })

        this.$wait = this.$control.children[1].children[1];
        this.$wait.addEventListener('click', function(){
          if(self.$name){
            let key = self.$name.getAttribute('node-key');
            self.wait(key);
            self.update();
          }
        })

        this.$reject = this.$control.children[1].children[2];
        this.$reject.addEventListener('click', function(){
          if(self.$name){
            let key = self.$name.getAttribute('node-key');
            self.reject(key);
            self.update();
          }
        })
      };

      //更新可视化表格
      CheckList.prototype.update = function(){
        if(this.$table){
          this.$table.innerHTML = this._array(this.list);
          console.log('-----');
          console.log(this.history);
          console.log(this.status);
        }
      };

      //获取节点状态背景色
      CheckList.prototype._getNodeBgColor = function(key){
        let iStatus = this.getKeyStatus(key);
        let bgColor = '';
        if(iStatus.status == 2){
          bgColor = 'red';
        }else if(iStatus.status == 1){
          bgColor = 'green';
        }else if(iStatus.status == 3){
          bgColor = 'pink';
        }else if(this.cur.keys.includes(key)){
          bgColor = 'lightgreen';
        }

        return bgColor;
      };

      //生成可视化表格 html 代码
      CheckList.prototype._array = function (array) {
        let end = array[array.length - 1];
        let html = "<table>";
        if (this._isNumber(end)) {
          //最后一位是数字，并行
          for (let i = 0; i < array.length - 1; i++) {
            let item = array[i];
            if (Array.isArray(item)) {
              html += "<tr><td>";
              html += this._array(item);
              html += "</td></tr>";
            } else {
              html += "<tr><td node-type='key' style='background-color:"+this._getNodeBgColor(item)+";'>";
              html += item;
              html += "</td></tr>";
            }
          }
        } else {
          //串行
          html += "<tr>";
          for (let i = 0; i < array.length; i++) {
            let item = array[i];
            if (Array.isArray(item)) {
              html += "<td>";
              html += this._array(item);
              html += "</td>";
            } else {
              html += "<td node-type='key' style='background-color:"+this._getNodeBgColor(item)+";'>";
              html += item;
              html += "</td>";
            }
          }
          html += "</tr>";
        }
        html += "</table>";
        return html;
      };

      //判断是否是数字
      CheckList.prototype._isNumber = function (num) {
        return typeof num === "number" && !isNaN(num);
      };
    </script>
  </body>
</html>
