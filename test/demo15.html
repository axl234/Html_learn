<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>串并连奖项审核 DEMO</title>
    <style>
      table td {
        border: 1px solid #000;
        margin: 1px;
      }
    </style>
  </head>
  <body>
    <script src="../lib/state-machine.js"></script>
    <script>
      window.onload = function () {
        var data1 = ["A", "B", "C", "D", "E"]; //串连
        var data2 = ["A", ["B", "C", 2], "D", ["E", "F", 2], "G"]; //串+并连 简单混合
        var data3 = [
          "A",
          [["B", [["C", "D"], "E", "F", 3]], ["G", "H"], 2],
          "I",
        ]; //串+并连 复杂混合

        var list1 = new CheckList(data3);
        list1.table();
      };

      //审核列表
      function CheckList(list, cur, history) {
        /**
         * 列表说明
         * 1、第一项 和 最后一项必须为单项；
         * 2、不允许重复关键字；
         * 3、数组末尾存在数字，则数组元素属于并行结构，该数字表示并行结构中的最少通过数；没有数字则属于串行结构；
         * 4、子数组不能为空
         */

        //列表校验
        this.list = list;

        let defCur = {
          keys: [this.list[0]],
          indexs: ["0"],
        };

        this.status = 0; // 0 未评审、1 通过、2 未通过、3 驳回
        this.cur = cur ? cur : defCur;
        this.history = history && history.length > 0 ? history : []; // 历史记录
      }

      CheckList.prototype.check = function () {
        //根据历史记录校验当前状态
        //历史记录不能存在状态为 0 的记录
        //历史记录不能存在重复记录
      };

      //完成
      CheckList.prototype.finish = function(list, index){
        //列表已完成，删除归属于当前列表的流程
        let newKeys = [];
        let newIndexs = [];
        for(let i=0;i<this.cur.indexs.length;i++){
          if(this.cur.indexs[i].indexOf(index) != 0){//列表
            newKeys.push(this.cur.keys[i]);
            newIndex.push(this.cur.indexs[i]);
          }
        }
        this.cur.keys = newKeys;
        this.cur.indexs = newIndexs;

        //递归处理父列表
        let arr = index.split('-');

        let parent = this.getList(index);
        let parentIndex = '';
        if(parent && parent.length > 0){
          if(this.isFinished(parent)){ //父列表也完成了

          }else{ //父列表没完成

          }
        }else{
          throw new Error(JSON.stringify({
            errCode: 403,
            errMsg: '审核列表数据异常',
            data: {
              index: index,
              list: this.list
            }
          }))
        }
      }

      /**
       * 下一步
       * list 当前列表
       * lIndex 当前列表索引
       * curIndex 当前流程索引
       */
      CheckList.prototype.next = function(list, lIndex, curIndex){
        if(!this._isNumber(list[list.length-1])){//当前节点所在的审核列表为串行列表
          let arr = curIndex.split('-');
          let next = parseInt(arr[arr.length-1])+1;
          let nextNode = list[next]
          if(!nextNode){
            throw new Error(JSON.stringify({
              errCode: 300,
              errMsg: '审核列表数据异常',
              data: {
                index: curIndex,
                list: list
              }
            }))
          }

          //nextIndex
          let nextIndex = '';
          for(let i=0;i<arr.length-1;i++){
            nextIndex += arr[i]+'-';
          }
          nextIndex += next;

          if(nextNode.length>=0){ //列表节点
            if(this.isFinished(nextNode)){
              this.finish(nextNode, nextIndex)
            }else{
              if(this._isNumber(nextNode[nextNode.length-1])){ //并行列表

              }else{ //串行列表
                this.ready1(nextNode, nextIndex, nextNode[0], nextIndex+'-0');
              }
            }
          }else{
            this.ready1(list, lIndex, nextNode, nextIndex)
          }
        }else{
          //并行列表删除当前流程即可
        }
      }

      //准备处理某个并行列表节点
      CheckList.prototype.ready2 = function(list, lIndex){
        for(let i=0;i<list.length;i++){
          let node = list[i];
          if(node.length>0){ //列表元素
            if(this.isFinished(node, lIndex+'-'+i)){
              // nothing
            }else{
              if(this._isNumber(node[node.length-1])){ //并行列表
                this.ready2(node, lIndex+'-'+i);
              }else{ // 串行列表
                this.ready1(node, lIndex+'-'+i, node[0], lIndex+'-'+i+'-0');
              }
            }
          }else{ //节点元素
            let exist = false;
            for(let j=0;j<this.history.length;j++){
              if(this.history[j].key == node){ //历史记录中存在
                if(this.history[j].status == 1){ //pass
                }else{
                  this.status = this.history[i].status;
                }
                exist = true;
              }
            }
            if(!exist){ //历史记录中不存在则加入当前流程
              this.cur.keys.push(node);
              this.cur.indexs.push(lIndex+'-'+i);
            }
          }
        }
      }

      /**
       * 准备处理串行列表中的某个节点（该串行列表并没有完成）
       */
      CheckList.prototype.ready1 = function(list, lIndex, curNode, curIndex){
        if(curNode.length>0){ //列表元素
          if(this.isFinished(curNode)){ // 已完成
            this.next(list, lIndex, curIndex); //下一步
          }else{
            if(this._isNumber(curNode[curNode.length-1])){ //并行列表
              this.ready2(curNode, curIndex)
            }else{ //串行列表
              this.ready1(curNode, curIndex, curNode[0], curIndex+'-0');
            }
          }
        }else{ //节点元素
          let exist = false;
          for(let i=0;i<this.history.length;i++){
            if(this.history[i].key == curNode){ //历史记录中存在
              if(this.history[i].status == 1){ //pass
                this.next(list, lIndex, curIndex); // 再下一步
              }else{
                this.status = this.history[i].status;
              }
              exist = true;
              break;
            }
          }
          if(!exist){//历史记录中不存在则加入当前流程
            this.cur.keys.push(curNode);
            this.cur.indexs.push(curIndex);
          }
        }
      }

      //通过
      CheckList.prototype.pass = function (key) {
        if (!this.cur.keys.includes(key)) {
          //查询是否处于当前流程
          throw new Error(JSON.stringify({
            errCode: 100,
            errMsg: '未匹配到当前流程',
            data:{
              key: key,
              keys: this.cur.keys
            }
          }))
        }

        if (this.status == 2 || this.status == 3) {
          //驳回或者未通过状态，不能进行操作
          throw new Error(JSON.stringify({
            errCode: 101,
            errMsg: '处于未通过或者驳回状态，不能执行 pass 操作',
            data:{
              key: key,
              history: this.history,
              status: this.status
            }
          }))
        }

        let no = this.cur.keys.indexOf(key);
        let index = this.cur.indexs[no];
        this.history.push({
          //加入操作历史记录
          key: key,
          index: index,
          status: 1,
        });
        this.status = 1; //更新状态
        this.cur.keys = this.cur.keys.splice(no, 1); //删除当前流程
        this.cur.indexs = this.cur.indexs.splice(no, 1);

        let list = this.getList(index);
        let llt = list.list;
        if(list && llt && llt.length > 0){
          if(!this.isFinished(llt)){ //当前节点所在的审核列表并没有完成
            this.next(llt, list.index, index);
          }else{
            this.finish(llt, list.index)
          }
        }else{
          throw new Error(JSON.stringify({
            errCode: 102,
            errMsg: '审核列表数据异常',
            data: {
              index: index,
              list: list
            }
          }))
        }
      };

      //获取父节点索引
      // CheckList.prototype.getParentIndex = function(index){
      //   let arr = index.split('-');
      //   if(arr.length > 1){
      //     let parentIndex = '';
      //     for(let i=0;i<arr.length-1;i++){
      //       parentIndex += arr[i]+'-';
      //     }
      //     parentIndex = parentIndex.substring(0,parentIndex.length-1);//去掉最后一位的横线
      //     return parentIndex;
      //   }else{
      //     return null;
      //   }
      // }

      //查找当前元素所在的审核列表
      CheckList.prototype.getList = function (index) {
        let arr = index.split("-");
        if(arr && arr.length>=1){
          if (arr.length == 1) { //只有一层序号，最外层列表
            return {
              index : -1,
              list : this.list
            };
          } else {
            let list = this.list;
            let listIndex = '';
            for (let i = 0; i < arr.length - 1; i++) {
              list = list[arr[i]];
              listIndex += arr[i]+'-';
            }
            listIndex = listIndex.substring(0, listIndex.length-1);//去掉最后一位横线
            return {
              index: listIndex,
              list: list
            };
          }
        }else{
          throw new Error(JSON.stringify({
            errCode: 200,
            errMsg: '节点索引异常',
            data: {
              index: index
            }
          }))
        }
      };

      //当前审核列表是否完成
      CheckList.prototype.isFinished = function (list) {
        let total = list.length;
        if (this._isNumber(list[list.length - 1])) {
          total = list[list.length - 1];
        }
        let count = 0;
        for (let i = 0; i < list.length; i++) {
          let item = list[i];
          if(item.length>=0){ //列表元素
            if (this.isFinished(item)) {
              count++;
            }
          }else{ //节点元素
            for (j = 0; j < this.history.length; j++) {
              if (this.history[j].key == item && this.history[j].status == 1) {
                count++;
                break;
              }
            }
          }
        }
        if (count >= total) {
          return true;
        } else {
          return false;
        }
      };

      //构建 table 可视化 demo
      CheckList.prototype.table = function () {
        this.$table = document.createElement("table");
        this.$table.innerHTML = this._array(this.list);
        document.body.appendChild(this.$table);
      };
      CheckList.prototype._array = function (array) {
        let end = array[array.length - 1];
        let html = "<table>";
        if (this._isNumber(end)) {
          //最后一位是数字，并行
          for (let i = 0; i < array.length - 1; i++) {
            let item = array[i];
            html += "<tr><td>";
            if (Array.isArray(item)) {
              html += this._array(item);
            } else {
              html += item;
            }
            html += "</td></tr>";
          }
        } else {
          //串行
          html += "<tr>";
          for (let i = 0; i < array.length; i++) {
            let item = array[i];
            html += "<td>";
            if (Array.isArray(item)) {
              html += this._array(item);
            } else {
              html += item;
            }
            html += "</td>";
          }
          html += "</tr>";
        }
        html += "</table>";
        return html;
      };

      //判断是否是数字
      CheckList.prototype._isNumber = function (num) {
        return typeof num === "number" && !isNaN(num);
      };
    </script>
  </body>
</html>
